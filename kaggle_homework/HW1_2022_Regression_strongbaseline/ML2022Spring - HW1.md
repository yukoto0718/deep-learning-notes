
# HW 1 Regression

Homework 1: COVID-19 Cases Prediction (Regression)

**kaggle url:** [ML2022Spring-hw1](https://www.kaggle.com/competitions/ml2022spring-hw1/overview)
**PDF url:** [HW01.pdf](https://speech.ee.ntu.edu.tw/~hylee/ml/ml2022-course-data/HW01.pdf)

### Objectives
ãƒ»Solve a regression problem with deep neural networks (DNN).
ãƒ»Understand basic DNN training tips e.g. hyper-parameter tuning, feature selection, regularization, â€¦
ãƒ»Get familiar with PyTorch.


### Grading -- Kaggle and Hints
```
---- simple baseline ----
Score:2.28371
(original)ML2022Spring_HW1.ipynb

---- medium baseline ----
Score:1.49430
Feature selection

---- strong baseline ----
Score:1.05728
Different model architectures and optimizers

---- boss baseline ----
Score:0.86161
L2 regularization and try more parameters
```

### Analysis-ç‰¹å¾å·¥ç¨‹
```
# æ•°æ®åˆ—è§£é‡Š
"""
ç¬¬0åˆ—: id (æ ·æœ¬ç¼–å·)
ç¬¬1-37åˆ—: AL, AK, AZ, ..., WA (37ä¸ªå·çš„one-hotç¼–ç )
ç¬¬38-53åˆ—: ç¬¬1å¤©çš„16ä¸ªç‰¹å¾
ç¬¬54-69åˆ—: ç¬¬2å¤©çš„16ä¸ªç‰¹å¾  
ç¬¬70-85åˆ—: ç¬¬3å¤©çš„16ä¸ªç‰¹å¾
ç¬¬86-101åˆ—: ç¬¬4å¤©çš„16ä¸ªç‰¹å¾
ç¬¬102-117åˆ—: ç¬¬5å¤©çš„16ä¸ªç‰¹å¾
ç¬¬118åˆ—: tested_positive (ç›®æ ‡å˜é‡ï¼Œç¬¬5å¤©çš„é˜³æ€§ç‡)
"""

# 16ä¸ªç‰¹å¾åˆ†åˆ«æ˜¯ï¼š
features_per_day = [
    'cli',                    # COVIDç—‡çŠ¶
    'ili',                    # æµæ„Ÿç—‡çŠ¶  
    'hh_cmnty_cli',          # å®¶åº­ç¤¾åŒºCLI
    'nohh_cmnty_cli',        # éå®¶åº­ç¤¾åŒºCLI
    'wearing_mask',          # æˆ´å£ç½©
    'travel_outside_state',  # å·å¤–æ—…è¡Œ
    'work_outside_home',     # å¤–å‡ºå·¥ä½œ
    'shop',                  # è´­ç‰©
    'restaurant',            # å»é¤å…
    'spent_time',            # èŠ±è´¹æ—¶é—´
    'large_event',           # å¤§å‹æ´»åŠ¨
    'public_transit',        # å…¬å…±äº¤é€š
    'anxious',               # ç„¦è™‘
    'depressed',             # æŠ‘éƒ
    'worried_finances',      # è´¢åŠ¡æ‹…å¿§
    'tested_positive'        # æ£€æµ‹é˜³æ€§(å‰4å¤©çš„å†å²æ•°æ®)
]
```

**step1:** 
Ground Truth vs Prediction å›¾: ç”¨æ¥ç›´è§‚æ£€æŸ¥æ¨¡å‹é¢„æµ‹è´¨é‡çš„æœ€é‡è¦å·¥å…·ä¹‹ä¸€ã€‚
åœ¨ä½¿ç”¨æ‰‹åŠ¨åˆ†æçš„ç‰¹å¾åï¼Œé€‰æ‹©ä»¥ä¸‹ç‰¹å¾ï¼š
```
for time_period in range(4):  # å‰4å¤©
    # æ¯å¤©é€‰æ‹©4ä¸ªç‰¹å¾(4*4å…±16ä¸ªç‰¹å¾)ï¼š
    - tested_positive  # å‰å‡ å¤©çš„é˜³æ€§ç‡
    - ili             # æµæ„Ÿç—‡çŠ¶
    - cli             # COVIDç—‡çŠ¶  
    - hh_cmnty_cli    # å®¶åº­ç¤¾åŒºCLI
```

å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š
```
å·¦ä¸‹è§’ï¼ˆçœŸå®å€¼0-5ï¼‰ âœ…
ãƒ»æ¯”è¾ƒé è¿‘çº¢çº¿ï¼Œé¢„æµ‹è¿˜ç®—å‡†ç¡®
å³ä¸Šè§’ï¼ˆçœŸå®å€¼15+ï¼‰ âŒ
ãƒ»å¾ˆåˆ†æ•£ï¼Œé¢„æµ‹å¾ˆä¸å‡†ç¡®
å…³é”®é—®é¢˜ï¼šå½“çœŸå®å€¼å¾ˆé«˜æ—¶ï¼Œæ¨¡å‹æ€»æ˜¯é¢„æµ‹åä½ï¼
å¯èƒ½åŸå› ï¼š
ãƒ»æ•°æ®ä¸å¹³è¡¡ - é«˜å€¼æ ·æœ¬å¤ªå°‘ï¼Œæ¨¡å‹æ²¡å­¦ä¼š
ãƒ»æ¨¡å‹å¤ªç®€å• - 3å±‚ç½‘ç»œå¯èƒ½ä¸å¤Ÿ
ãƒ»ç‰¹å¾ä¸å¤Ÿå¥½ - æ²¡æœ‰èƒ½åŒºåˆ†é«˜å€¼æƒ…å†µçš„ç‰¹å¾
ãƒ»æ•°æ®æ²¡æœ‰å½’ä¸€åŒ– - ä¸åŒç‰¹å¾å°ºåº¦å·®å¤ªå¤§
```
![image1](./img/hw1_image1.png)

**step2:** 
>SelectKBest æ˜¯ scikit-learn ä¸­çš„ä¸€ä¸ªè‡ªåŠ¨ç‰¹å¾é€‰æ‹©å·¥å…·ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ä»ä¸€å¤§å †ç‰¹å¾ä¸­è‡ªåŠ¨æŒ‘é€‰å‡º"æœ€æœ‰ç”¨"çš„ K ä¸ªç‰¹å¾ã€‚

ä½¿ç”¨SelectKBestä»å‰©ä½™ç‰¹å¾ä¸­è‡ªåŠ¨é€‰12ä¸ª(å¦‚å›¾æ‰€ç¤º12ä¸ªçš„æƒ…å†µä¸‹ç»“æœæœ€å¥½)
![image2](./img/hw1_image2.png)


### ä¿®æ”¹æ¨¡å‹
ä»3ä¸ªçº¿å±‚æ¢åˆ°2ä¸ªçº¿æ€§å±‚ï¼Œæ¢æˆLeakyReLUï¼Œå¢åŠ BatchNorm1då’ŒDropoutçš„ä½¿ç”¨

ä»€ä¹ˆæ˜¯ LeakyReLUï¼Ÿ 
```python
# ReLU: å°äº0çš„å…¨éƒ¨å˜æˆ0
def relu(x):
    return max(0, x)
# è¾“å…¥: [-2, -1, 0, 1, 2] 
# è¾“å‡º: [0, 0, 0, 1, 2]   â† è´Ÿæ•°ä¿¡æ¯å…¨ä¸¢äº†ï¼

# LeakyReLU: å°äº0çš„ä¿ç•™ä¸€ç‚¹ç‚¹
def leaky_relu(x, alpha=0.01):
    return max(alpha * x, x)
# è¾“å…¥: [-2, -1, 0, 1, 2]
# è¾“å‡º: [-0.02, -0.01, 0, 1, 2]  â† è´Ÿæ•°ä¿¡æ¯ä¿ç•™äº†ä¸€ç‚¹ç‚¹ï¼
```

### æ•°æ®å½’ä¸€åŒ–
åœ¨select_featå¤„åŠ ä¸Šæ•°æ®å½’ä¸€åŒ–ã€‚
>æ”¹å®Œåå‘ç°å®Œå…¨æ²¡æœ‰å˜åŒ–

ä»€ä¹ˆæ˜¯æ•°æ®å½’ä¸€åŒ–
```
# ä½ çš„åŸå§‹æ•°æ®å¯èƒ½é•¿è¿™æ ·ï¼š
ç‰¹å¾A (å¹´é¾„):        [25, 30, 35, 40]     # èŒƒå›´ï¼š15
ç‰¹å¾B (æ”¶å…¥):        [50000, 60000, 80000, 100000]  # èŒƒå›´ï¼š50000 
ç‰¹å¾C (é˜³æ€§ç‡):      [0.1, 0.2, 0.15, 0.3]  # èŒƒå›´ï¼š0.2

# å½’ä¸€åŒ–åå˜æˆï¼š
ç‰¹å¾A:              [0.0, 0.33, 0.67, 1.0]    # èŒƒå›´ï¼š1
ç‰¹å¾B:              [0.0, 0.2, 0.6, 1.0]      # èŒƒå›´ï¼š1  
ç‰¹å¾C:              [0.0, 0.5, 0.25, 1.0]     # èŒƒå›´ï¼š1
```
### ä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡çš„ä¿®æ”¹
1.ä»SGDæ¢æˆAdamå’ŒL2æ­£åˆ™åŒ–
```
å½’ä¸€åŒ–çš„ç›®æ ‡ï¼š
python# è§£å†³"ç‰¹å¾å°ºåº¦ä¸å¹³è¡¡"é—®é¢˜
ç‰¹å¾A: [1, 2, 3]        â†’ [0.0, 0.5, 1.0]
ç‰¹å¾B: [1000, 2000, 3000] â†’ [0.0, 0.5, 1.0]
# è®©æ‰€æœ‰ç‰¹å¾åœ¨åŒä¸€èµ·è·‘çº¿
L2æ­£åˆ™åŒ–çš„ç›®æ ‡ï¼š
python# è§£å†³"æƒé‡è¿‡å¤§ï¼Œè¿‡æ‹Ÿåˆ"é—®é¢˜  
æƒé‡: [10.5, -8.3, 15.2] â†’ [2.1, -1.8, 3.2]
# è®©æƒé‡ä¿æŒåˆç†å¤§å°
```
2.åŠ ä¸Šå­¦ä¹ ç‡è°ƒåº¦å™¨
```
# æ²¡æœ‰è°ƒåº¦å™¨ - å›ºå®šå­¦ä¹ ç‡
å­¦ä¹ ç‡ = 0.01  # ä¸€ç›´å¼€60km/h

å¼€å§‹è®­ç»ƒ: ğŸš—ğŸ’¨ğŸ’¨ğŸ’¨ é«˜é€Ÿå‰è¿› (è¿œç¦»ç›®æ ‡)
ä¸­æœŸè®­ç»ƒ: ğŸš—ğŸ’¨ğŸ’¨   è¿˜æ˜¯60km/h (æ¥è¿‘ç›®æ ‡) 
åæœŸè®­ç»ƒ: ğŸš—ğŸ’¨ğŸ’¨   è¿˜æ˜¯60km/h (å·²ç»å¾ˆæ¥è¿‘ç›®æ ‡äº†ï¼Œä½†æ­¥å­å¤ªå¤§ï¼Œæ€»æ˜¯è¶Šè¿‡æœ€ä¼˜ç‚¹!)
# æœ‰è°ƒåº¦å™¨ - åŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡  
å¼€å§‹: ğŸš—ğŸ’¨ğŸ’¨ğŸ’¨ 120km/h (å¿«é€Ÿæ¥è¿‘)
ä¸­æœŸ: ğŸš—ğŸ’¨ğŸ’¨   60km/h  (ç¨³æ­¥å‰è¿›)
åæœŸ: ğŸš—ğŸ’¨     20km/h  (ç²¾ç»†è°ƒæ•´ï¼Œå‡†ç¡®åœåœ¨æœ€ä½³ä½ç½®!)
```
3.åŒæ—¶è°ƒæ•´é…ç½®
```
config = {
    'n_epochs': 5000,     # 3000>5000
    'learning_rate': 1e-5, #1e-3>1e-5
    'early_stop': 500,    # 400>500
}
```

### æœ€ç»ˆæˆç»© strong baseline
![image3](./img/hw1_image3.png)